<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>logger</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    .app {
      display: flex;
      height: 100%;
    }

    .control-panel {
      width: 35vw;
      max-width: 320px;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 8px;
    }

    .row input[type="text"] {
      width: 8ch;
      padding: 4px;
      font-size: 16px;
    }

    .main-area {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body>

<div class="app">

  <div class="control-panel">
    <!-- 25 rows -->
    <script>
      for (let i = 1; i <= 25; i++) {
        document.write(`
          <div class="row">
            <input type="radio" name="slot">
            <input type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Label ${i}">
          </div>
        `);
      }
    </script>
  </div>

  <div class="main-area">
    <div style="margin-bottom:10px;">
      <button id="logBtn">Log Time</button>
      <input id="logOutput" type="text" style="margin-left:10px; width:140px;">
      <button id="openTableBtn" style="margin-left:10px;">Open Table</button>
    </div>

    <table id="logTable" border="1" cellpadding="5" style="border-collapse:collapse; width:100%;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Time</th>
          <th>Focus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ===========================
   GLOBAL STATE
=========================== */
let apptfocus = "";
let db;

/* ===========================
   ROW / RADIO / TEXTBOX LOGIC
=========================== */
document.querySelectorAll('.row').forEach(row => {
  const radio = row.querySelector('input[type="radio"]');
  const textbox = row.querySelector('input[type="text"]');

  radio.addEventListener('change', () => {
    if (!textbox.value) {
      textbox.focus();
    } else {
      apptfocus = textbox.value;
      updateLogOutputForFocus();
    }
  });

  textbox.addEventListener('focus', () => {
    radio.checked = true;
  });

  textbox.addEventListener('blur', () => {
    apptfocus = textbox.value;
    updateLogOutputForFocus();
  });
});

/* ===========================
   INDEXED DB SETUP
=========================== */
const request = indexedDB.open("TimeLogDB", 1);

request.onupgradeneeded = e => {
  db = e.target.result;
  const store = db.createObjectStore("logs", {
    keyPath: "id",
    autoIncrement: true
  });
  store.createIndex("focus", "focus", { unique: true });
};

request.onsuccess = e => {
  db = e.target.result;
  loadTable();
};

request.onerror = e => {
  console.error("DB error", e.target.error);
};

/* ===========================
   DB HELPERS
=========================== */
function getRecordByFocus(focus) {
  return new Promise(resolve => {
    const tx = db.transaction("logs", "readonly");
    const store = tx.objectStore("logs");
    const index = store.index("focus");

    const req = index.get(focus);
    req.onsuccess = () => resolve(req.result || null);
  });
}

/* ===========================
   TABLE FUNCTIONS
=========================== */
const tableBody = document.querySelector("#logTable tbody");

function loadTable() {
  tableBody.innerHTML = "";
  const tx = db.transaction("logs", "readonly");
  const store = tx.objectStore("logs");

  store.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      const r = cursor.value;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.time}</td>
        <td>${r.focus}</td>
      `;
      tableBody.appendChild(tr);
      cursor.continue();
    }
  };
}

/* ===========================
   UPDATE OUTPUT FOR FOCUS
=========================== */
async function updateLogOutputForFocus() {
  if (!apptfocus || !db) {
    logOutput.value = "";
    return;
  }

  const record = await getRecordByFocus(apptfocus);
  logOutput.value = record ? record.time : "";
}

/* ===========================
   LOG BUTTON
=========================== */
const logBtn = document.getElementById("logBtn");
const logOutput = document.getElementById("logOutput");

logBtn.addEventListener("click", async () => {
  if (!apptfocus) {
    alert("Select or enter a focus first");
    return;
  }

  const now = new Date().toLocaleTimeString();
  logOutput.value = now;

  const existing = await getRecordByFocus(apptfocus);

  const tx = db.transaction("logs", "readwrite");
  const store = tx.objectStore("logs");

  let writeReq;

  if (existing) {
    existing.time = now;
    writeReq = store.put(existing);
  } else {
    writeReq = store.add({
      focus: apptfocus,
      time: now
    });
  }

  writeReq.onsuccess = () => {
    loadTable(); // âœ… guaranteed DB is updated
  };

  writeReq.onerror = () => {
    console.error("Failed to write log entry");
  };
});

  
  logOutput.addEventListener("blur", async () => {
  if (!apptfocus || !db) return;

  const newTime = logOutput.value.trim();
  if (!newTime) return;

  const existing = await getRecordByFocus(apptfocus);
  if (!existing) return;

  const tx = db.transaction("logs", "readwrite");
  const store = tx.objectStore("logs");

  existing.time = newTime;
  const req = store.put(existing);

  req.onsuccess = () => {
    loadTable(); // reflect edit immediately
    console.log("Time updated for focus:", apptfocus);
  };

  req.onerror = () => {
    console.error("Failed to update time");
  };
});

/* ===========================
   OPEN TABLE IN NEW WINDOW
=========================== */
document.getElementById("openTableBtn").addEventListener("click", () => {
  const rows = [];

  const tx = db.transaction("logs", "readonly");
  const store = tx.objectStore("logs");

  store.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      rows.push(cursor.value);
      cursor.continue();
    } else {
      const win = window.open("", "_blank");
      win.document.write(`
        <html>
        <head>
          <title>Time Log</title>
          <style>
            body { font-family: sans-serif; padding: 10px; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #999; padding: 6px; }
            th { background: #eee; }
          </style>
        </head>
        <body>
          <h2>Time Log</h2>
          <table>
            <tr><th>ID</th><th>Time</th><th>Focus</th></tr>
            ${rows.map(r =>
              `<tr><td>${r.id}</td><td>${r.time}</td><td>${r.focus}</td></tr>`
            ).join("")}
          </table>
        </body>
        </html>
      `);
      win.document.close();
    }
  };
});
</script>

</body>
</html>
