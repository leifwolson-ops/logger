<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>logger</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  font-family: sans-serif;
}

.app {
  display: flex;
  height: 100%;
}

.control-panel {
      width: 35vw;
      max-width: 120px;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
}

.row {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
}

.row input[type="text"] {
  width: 6ch;
  padding: 4px;
  font-size: 16px;
}

.main-area {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.event-row {
  display: flex;
  align-items: center; /* vertically center label + input */
  gap: 6px;            /* space between label and textbox */
  margin-bottom: 6px;  /* space between rows */
}



  
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">


</style>
</head>

<body>

<div class="app">

  <div class="control-panel" id="panel"></div>

<div class="main-area">
  <div class="event-row">
    <label for="arrivedOutput">arrived</label>
    <input id="arrivedOutput" type="text" inputmode="numeric" pattern="[0-9]*" style="margin-left:10px;width:140px;font-size:16px;">
  </div>

  <div class="event-row">
    <label for="inOutput">in</label>
    <input id="inOutput" type="text" inputmode="numeric" pattern="[0-9]*" style="margin-left:10px;width:140px;font-size:16px;">
  </div>

  <div class="event-row">
    <label for="outOutput">out</label>
    <input id="outOutput" type="text" inputmode="numeric" pattern="[0-9]*" style="margin-left:10px;width:140px;font-size:16px;">
  </div>

    <table id="logTable" border="1" cellpadding="5" style="margin-top:10px;width:100%;">
      <thead>
        <tr>
          <th>index</th>
          <th>appt time</th>
          <th>event</th>   
          <th>user input</th>
          <th>timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  
</div>

<script>


  if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

  
/* ===========================
   BUILD ROWS
=========================== */
const panel = document.getElementById("panel");

for (let i = 1; i <= 25; i++) {
  const row = document.createElement("div");
  row.className = "row";
  row.setAttribute("data-row-id", i);
  
  row.innerHTML = `
    <input type="radio" name="slot">
    <input type="text" inputmode="numeric" pattern="[0-9]*" placeholder="${i}" 
       onblur="saveApptTime(${i}, this.value)"> 
      `;
  

  panel.appendChild(row);
}



/* ===========================
   TIME CONVERTER
=========================== */
function convertTypedTime(text) {
  text = text.trim();
  if (!/^\d{3,4}$/.test(text)) return null;

  const n = Number(text);
  if (n < 0 || n > 2359) return null;

  let hour = text.length === 3 ? Number(text[0]) : Number(text.slice(0, 2));
  let min = Number(text.slice(-2));
  if (min > 59) return null;

  const am = hour >= 7 && hour <= 11;
  let period = am ? "AM" : "PM";

  if (hour > 12) hour -= 12;
  if (hour === 0) hour = 12;

  return `${hour}:${String(min).padStart(2,"0")} ${period}`;
}


  function saveApptTime(rowId, value) {
  const tx = db.transaction("apptTimes", "readwrite");
  const store = tx.objectStore("apptTimes");
  store.put({ rowId, value });
}

function loadApptTimes() {
  const tx = db.transaction("apptTimes", "readonly");
  const store = tx.objectStore("apptTimes");
  const request = store.getAll();

  request.onsuccess = function() {
    request.result.forEach(item => {
      const row = document.querySelector(`[data-row-id="${item.rowId}"] input[type="text"]`);
      if (row) row.value = item.value;
    });
  };
}


function getSelectedApptTime() {
  const selected = document.querySelector('input[name="slot"]:checked');
  if (!selected) return "";

  const row = selected.closest(".row");
  return row.querySelector('input[type="text"]').value || "";
}

function saveLog(eventName, userInput) {

  if (!userInput) return;

  const timestamp = convertTypedTime(userInput);
  if (!timestamp) return;

  const apptTime = getSelectedApptTime();
  if (!apptTime) return;

  const tx = db.transaction("logs", "readwrite");
  const store = tx.objectStore("logs");
  const index = store.index("appt_event");

  const lookup = index.get([apptTime, eventName]);

  lookup.onsuccess = function() {

    let record = lookup.result;

    /* =====================
       MATCH FOUND → UPDATE
    ====================== */
    if (record) {

      record.userInput = userInput;
      record.timestamp = timestamp;

      store.put(record);
      updateRowInTable(record);
    }

    /* =====================
       NO MATCH → CREATE
    ====================== */
    else {

      record = {
        index: logIndex++,
        apptTime,
        event: eventName,
        userInput,
        timestamp
      };

      store.put(record);
      addRowToTable(record);
    }
  };
}

  
  function updateRowInTable(data) {

  const rows = document.querySelectorAll("#logTable tbody tr");

  rows.forEach(r => {

    if (Number(r.children[0].textContent) === data.index) {

      r.children[1].textContent = data.apptTime;
      r.children[2].textContent = data.event;
      r.children[3].textContent = data.userInput;
      r.children[4].textContent = data.timestamp;
    }
  });
}
  

document.getElementById("arrivedOutput")
  .addEventListener("blur", function() {
    ssaveLog("arrived", this.value);
this.value = "";
  });

document.getElementById("inOutput")
  .addEventListener("blur", function() {
    saveLog("arrived", this.value);
this.value = "";
  });

document.getElementById("outOutput")
  .addEventListener("blur", function() {
    saveLog("arrived", this.value);
this.value = "";
  });


  function addRowToTable(data) {
  const tbody = document.querySelector("#logTable tbody");

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${data.index}</td>
    <td>${data.apptTime}</td>
    <td>${data.event}</td>
    <td>${data.userInput}</td>
    <td>${data.timestamp}</td>
  `;

  tbody.appendChild(row);
}

function loadLogs() {
  const tx = db.transaction("logs", "readonly");
  const store = tx.objectStore("logs");
  const request = store.getAll();

  request.onsuccess = function() {
    const logs = request.result.sort((a,b) => a.index - b.index);

    logs.forEach(log => {
      addRowToTable(log);
    });

    if (logs.length > 0) {
      logIndex = logs[logs.length - 1].index + 1;
    }
  };
}


  /* ===========================
   INDEXED DB SETUP
=========================== */

let db;
let logIndex = 1;

const request = indexedDB.open("LoggerDB", 2);

request.onupgradeneeded = function(e) {

  db = e.target.result;

  /* ======================
     CREATE LOG STORE
  ====================== */

  let logStore;

  if (!db.objectStoreNames.contains("logs")) {

    logStore = db.createObjectStore("logs", {
      keyPath: "index"
    });

  } else {

    logStore = e.target.transaction.objectStore("logs");
  }

  /* ======================
     ADD COMPOSITE INDEX
  ====================== */

  if (!logStore.indexNames.contains("appt_event")) {

    logStore.createIndex(
      "appt_event",        // index name
      ["apptTime","event"],// fields
      { unique:false }
    );
  }

  /* ======================
     APPT TIMES STORE
  ====================== */

  if (!db.objectStoreNames.contains("apptTimes")) {
    db.createObjectStore("apptTimes", { keyPath: "rowId" });
  }

};

request.onsuccess = function(e) {
  db = e.target.result;
  loadApptTimes();
  loadLogs();
};

request.onerror = function() {
  console.error("DB failed to open");
};



  
  
</script>

</body>
</html>
